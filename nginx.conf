events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression (for client response only)
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index faceit.html;

        # Widget locations
        location /faceit { try_files $uri /faceit.html =404; }
        location = /faceit { try_files /faceit.html =404; }
        
        location /premier { try_files $uri /premier.html =404; }
        location = /premier { try_files /premier.html =404; }

        # --- CSSTATS PROXY FIX (HARDENED) ---
        location /csstats/ {
            proxy_pass https://csstats.gg/;
            
            # SSL Configuration
            proxy_ssl_server_name on;
            proxy_ssl_name csstats.gg;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            # Использование более широкого списка шифров
            proxy_ssl_ciphers DEFAULT; 

            # Connection settings
            proxy_http_version 1.1;
            proxy_set_header Connection "keep-alive";
            
            # Browser Emulation Headers
            proxy_set_header Host csstats.gg;
            # Chrome 122 User Agent
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36";
            proxy_set_header Referer "https://csstats.gg/";
            
            # Standard Accept headers
            proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
            proxy_set_header Accept-Language "en-US,en;q=0.9";
            
            # ВАЖНО: Запрашиваем контент без сжатия, чтобы избежать проблем с декодированием
            proxy_set_header Accept-Encoding "";
            
            # Cache Control - притворяемся, что кеша нет
            proxy_set_header Cache-Control "max-age=0";
            proxy_set_header Pragma "no-cache";

            # Privacy - удаляем все признаки прокси
            proxy_set_header X-Real-IP "";
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";
            proxy_set_header Via "";
            proxy_set_header CF-Connecting-IP "";
            proxy_set_header CF-IPCountry "";
            
            # Timeouts
            proxy_connect_timeout 15s;
            proxy_read_timeout 15s;
            
            # Не кешируем ошибки блокировки
            proxy_cache_valid 403 0;
            proxy_cache_valid 200 10m;
        }

        # FACEIT API Proxy
        location /api/ {
            rewrite ^/api/(.*)$ /data/v4/$1 break;
            proxy_pass https://open.faceit.com;
            proxy_ssl_server_name on;
            proxy_pass_request_body on;
            proxy_pass_request_headers on;
            proxy_set_header Host open.faceit.com;
            proxy_set_header Authorization $http_authorization;
            
            # CORS
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key" always;
            
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key" always;
                return 204;
            }
        }

        location = / { return 301 /faceit; }
        location = /favicon-sky.svg { try_files /favicon-sky.svg =404; }
        location / { try_files $uri $uri/ =404; }
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}